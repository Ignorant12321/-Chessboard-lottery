<!DOCTYPE html>
<html lang="zh-CN">

<!-- å¼•å…¥ Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- å…ƒæ•°æ® -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess Board</title>
</head>

<!-- ä¸»ä½“éƒ¨åˆ† -->

<body>
    <!-- ç¬¬ä¸€å±ï¼šæ¸¸æˆåŒº -->
    <section class="fullscreen-section">
        <div class="main-container">
            <!-- å·¦ä¾§ ä¿¡æ¯æ  -->
            <div class="info-panel">
                <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
                <button id="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼">â˜€</button>

                <!-- æ ‡é¢˜åŒº -->
                <div class="header">
                    <h1>æ£‹ç›˜æŠ½ç­¾</h1>
                    <p>Lucky Draw Simulation</p>
                </div>
                <!-- å¡ç‰‡åŒº -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-label">å·²æ”¶é›† (Collections)</span>
                        <span class="stat-value highlight" id="drawn-count">0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">è¡ŒåŠ¨æ•° (Actions)</span>
                        <span class="stat-value primary" id="current-actions">0</span>
                    </div>
                    <div class="stat-card" style="grid-column: span 2;">
                        <span class="stat-label">å½“å‰æ€»è¿›åº¦ï¼š</span>
                        <span class="stat-value" id="progress-value" style="text-align: right;">0%</span>
                        <!-- è¿›åº¦æ¡åŒº -->
                        <div class="progress-section">
                            <div class="progress-header">
                                <span>Collection Progress</span>
                            </div>
                            <div class="progress-container-inner">
                                <div class="progress-fill" id="progress-fill"></div> <!-- æ ‡è®°ç‚¹è¿›åº¦æ¡ -->
                                <div class="progress-marks"></div> <!-- æ ‡è®°ç‚¹å®¹å™¨ -->
                            </div>
                        </div>
                    </div>

                </div>

                <!-- æŒ‰é’®åŒº -->
                <div class="btn-group">
                    <button id="action-btn" class="btn btn-primary" onclick="performAction()">ğŸ² æ·éª° (Roll)</button>
                    <button id="reset-btn" class="btn btn-outline" onclick="resetBoard()">ğŸ”„ é‡ç½® (Reset)</button>
                </div>

            </div>

            <!-- å³ä¾§ æ£‹ç›˜åŒº -->
            <div class="board-panel">
                <div class="board-scaler">
                    <table id="chessboard">
                        <!-- JS åŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- ç¬¬äºŒå±ï¼šè®¾ç½®ä¸åˆ†æ -->
    <section class="tabs-section">
        <div class="tabs">
            <div class="tab-button" data-tab="tab-settings">âš™ï¸è®¾ç½® (Settings)</div>
            <div class="tab-button active" data-tab="tab-analyze">âœ’ï¸åˆ†æ (Analyze)</div>
            <div class="tab-button" data-tab="tab-stats">ğŸ“ˆç»Ÿè®¡ (Stats)</div>
            <div class="tab-button" data-tab="tab-sponsor">â„¹ï¸å…³äº (About)</div>
        </div>

        <div class="tab-content-container" id="tab-content-container">
            <!-- åˆ†æé¢æ¿ (é»˜è®¤æ˜¾ç¤º) -->
            <div class="tab-content active" id="tab-analyze">
                <div class="setting-group">
                    <h4>â€œè¡ŒåŠ¨æ¬¡æ•°-ä¸­ç­¾æ¬¡æ•°â€æŠ˜çº¿å›¾</h4>
                    <div class="chart-container">
                        <canvas id="lineChart"></canvas>
                    </div>
                    <div class="slider-wrapper">
                        <!-- æ–°å¢ï¼šæŠ˜çº¿å›¾çš„è¾“å…¥æ¡†å¤´éƒ¨ -->
                        <div class="slider-header">
                            <label>å›æ”¾è¿›åº¦ï¼š</label>
                            <input type="number" id="lineChart_input" class="settings-item-input" value="0" min="0"
                                max="0" style="width:60px;">
                        </div>
                        <!-- åŒ…è£¹æ»‘å—çš„å®¹å™¨ï¼Œç”¨äºå®šä½Tooltip -->
                        <div class="range-container">
                            <input type="range" id="lineChart_slider" class="custom-slider" step="0.01" value="0"
                                min="0" max="0.1">
                            <div id="lineChart_sliderTooltip" class="slider-tooltip">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è®¾ç½®é¢æ¿ -->
            <div class="tab-content" id="tab-settings">
                <div class="setting-group">
                    <h4>æ£‹ç›˜è§„æ ¼ (Standard)</h4>
                    <div class="setting-row"><label>è¡Œæ•° (Rows)</label><input type="number" id="rows"
                            class="settings-item-input" value="5" min="1"></div>
                    <div class="setting-row"><label>åˆ—æ•° (Cols)</label><input type="number" id="cols"
                            class="settings-item-input" value="5" min="1"></div>
                </div>
                <div class="setting-group">
                    <h4>æ¦‚ç‡æƒé‡ (Weights)</h4>
                    <div class="setting-row"><label>ä¸€æ¬¡æƒé‡ (æœªä¸­)</label><input type="number" id="first-weight"
                            class="settings-item-input" value="1" min="1"></div>
                    <div class="setting-row"><label>äºŒæ¬¡æƒé‡ (å·²ä¸­)</label><input type="number" id="second-weight"
                            class="settings-item-input" value="4" min="0"></div>
                </div>
                <div class="setting-group">
                    <h4>é™åˆ¶ (Limits)</h4>
                    <div class="setting-row"><label>æœ€å¤§è¡ŒåŠ¨æ¬¡æ•°</label><input type="number" id="max-actions"
                            class="settings-item-input" value="250" min="1"></div>
                </div>
                <p style="font-size:12px; color:var(--text-light); text-align:center;">ï¼ˆé‡ç½®å¯ç”¨è®¾ç½®ï¼Œè¡ŒåŠ¨æ—¶ç¦ç”¨è®¾ç½®ï¼‰</p>
            </div>

            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div class="tab-content" id="tab-stats">
                <div class="setting-group">
                    <h4>â€œè¡ŒåŠ¨æ¬¡æ•°-ä¸­ç­¾æ¬¡æ•°â€æ•£ç‚¹å›¾ï¼ˆScatterï¼‰</h4>
                    <div class="setting-row">
                        <label>ç›®æ ‡ç»Ÿè®¡æ¬¡æ•°ï¼š</label>
                        <div>
                            <input type="number" id="times" class="settings-item-input" value="10" min="1" max="100000"
                                style="margin-right:10px;">
                            <button class="btn btn-primary" id="btn-run-stats" onclick="runStatsWithEffect()"
                                style="padding: 6px 12px; font-size: 12px;">è¿è¡Œç»Ÿè®¡</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="scatterChart_tab3"></canvas>
                    </div>
                </div>

                <div class="setting-group">
                    <h4>ç›®æ ‡æŠ½ç­¾æ•°ä¸‹ï¼Œä¸­ç­¾æ¦‚ç‡é¥¼çŠ¶å›¾ï¼ˆPieï¼‰</h4>
                    <div class="chart-container">
                        <canvas id="pieChart_draw"></canvas>
                    </div>
                    <div class="slider-wrapper">
                        <!-- ä¼˜åŒ–ï¼šå¤´éƒ¨ç»“æ„ -->
                        <div class="slider-header">
                            <label>ç›®æ ‡æŠ½ç­¾æ¬¡æ•°ï¼š</label>
                            <input type="number" id="draw_total" class="settings-item-input" value="28" min="1"
                                max="250" style="width:60px;">
                        </div>
                        <div class="range-container">
                            <input type="range" id="pieChart_slider" class="custom-slider" step="0.01" value="28"
                                min="1" max="250">
                            <span id="pieChart_sliderTooltip" class="slider-tooltip">0</span>
                        </div>
                    </div>
                    <p class="result_p">
                        <span id="d_min">ğŸ”·æœ€å°å€¼: ???</span>
                        <span id="d_median">âš–ï¸ä¸­ä½æ•°: ???</span>
                        <span id="d_max">ğŸ”¶æœ€å¤§å€¼: ???</span>
                    </p>
                </div>

                <div class="setting-group">
                    <h4>ç›®æ ‡ä¸­ç­¾æ•°ä¸‹ï¼ŒæŠ½ç­¾æ¦‚ç‡å¯†åº¦å›¾ï¼ˆDensityï¼‰</h4>
                    <div class="chart-container">
                        <canvas id="scatterChart_winning"></canvas>
                    </div>
                    <div class="slider-wrapper">
                        <div class="slider-header">
                            <label>ç›®æ ‡ä¸­ç­¾æ¬¡æ•°ï¼š</label>
                            <input type="number" id="winning_total" class="settings-item-input" value="19" min="1"
                                max="25" style="width:60px;">
                        </div>
                        <div class="range-container">
                            <input type="range" id="densityChart_slider" class="custom-slider" step="0.01" value="19"
                                min="1" max="25">
                            <span id="densityChart_sliderTooltip" class="slider-tooltip">0</span>
                        </div>
                    </div>
                    <p class="result_p">
                        <span id="w_min">ğŸ”·æœ€å°å€¼: ???</span>
                        <span id="w_median">âš–ï¸ä¸­ä½æ•°: ???</span>
                        <span id="w_max">ğŸ”¶æœ€å¤§å€¼: ???</span>
                    </p>
                </div>
            </div>

            <!-- å…³äº -->
            <div class="tab-content" id="tab-sponsor">
                <div class="setting-group" style="text-align: center;">
                    <p>Created by Ignorant</p>
                    <p onclick="toggle_sponsorImg()"
                        style="cursor: pointer; color: var(--primary); text-decoration: underline;">ä¸ºçˆ±å‘ç”µï¼Œè¯·ä½œè€…å–æ¯å’–å•¡ â˜•ã€‚</p>
                    <img id="sponsorImg" alt="èµåŠ©äºŒç»´ç ">
                </div>
            </div>
        </div>
    </section>

    <!-- å¼¹çª— -->
    <div id="customDialog">
        <div class="custom-dialog-content">
            <h2 class="h2_dialog" id="headSpan">æç¤ºï¼š</h2>
            <div id="info_container" style="color:var(--text-light); margin-bottom:20px;"></div>
            <div>
                <button id="confirmButton" class="dialog-btn" style="background:var(--primary); color:#fff;">ç¡®è®¤</button>
                <button id="retryButton" class="dialog-btn"
                    style="background:var(--bg-secondary); color:var(--text-main);">é‡è¯•</button>
            </div>
        </div>
    </div>
</body>

<!-- åŸºæœ¬æ ·å¼ -->
<style>
    /* å…ƒç´ å˜é‡ */
    :root {
        /* äº®è‰²æ¨¡å¼ (é»˜è®¤) */
        --primary: #5e72e4;
        --primary-dark: #233dd2;
        --success: #2dce89;
        --warning: #fb6340;
        --info: #11cdef;
        --inactive-gray: #e2e8f0;

        --text-main: #32325d;
        --text-light: #8898aa;
        --text-chart: #666;
        /* å›¾è¡¨æ–‡å­—é¢œè‰² */

        --bg-body: #f8f9fe;
        --bg-card: #ffffff;
        --bg-secondary: #f4f5f7;
        /* é¢æ¿èƒŒæ™¯ */
        --bg-hover: #f6f9fc;
        --bg-input: #ffffff;

        --border-color: #e9ecef;
        --shadow: 0 15px 35px rgba(50, 50, 93, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);

        --cell-bg: #f7fafc;
        --cell-border: #e2e8f0;
        --cell-text: #4a5568;

        --radius: 16px;
    }

    /* æ·±è‰²æ¨¡å¼ */
    body.dark-mode {
        --primary: #758bfd;
        --primary-dark: #5e72e4;

        --text-main: #f0f2f5;
        --text-light: #a0aec0;
        --text-chart: #a0aec0;
        --inactive-gray: #4a5568;

        --bg-body: #121212;
        --bg-card: #1e1e1e;
        --bg-secondary: #121212;
        --bg-hover: #2d3748;
        --bg-input: #2d3748;

        --border-color: #2d3748;
        --shadow: 0 15px 35px rgba(0, 0, 0, 0.4), 0 5px 15px rgba(0, 0, 0, 0.3);

        --cell-bg: #2d3748;
        --cell-border: #4a5568;
        --cell-text: #e2e8f0;
    }

    /* å…¨å±€æ ·å¼ */
    body {
        font-family: 'Open Sans', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow-y: auto;
        overflow-x: hidden;
        user-select: none;
        transition: background-color 0.3s, color 0.3s;
    }

    /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
    #theme-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        background: transparent;
        border: 1px solid var(--border-color);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;

        /* ä¸»é¢˜åˆ‡æ¢åŠ¨ç”»ï¼šæ—¶é•¿å¢åŠ åˆ°0.8sï¼Œæ›²çº¿è°ƒæ•´ä¸ºæœ‰å¼¹æ€§çš„å›å¼¹æ•ˆæœ */
        transition: transform 0.8s cubic-bezier(0.34, 1.3, 0.64, 1), background-color 0.3s;

        color: var(--text-main);
        z-index: 20;
    }

    #theme-toggle:hover {
        background: var(--bg-hover);
        transform: rotate(90deg);
        /* æ‚¬åœæ—¶è½»å¾®æ—‹è½¬ */
    }

    /* æ·±è‰²æ¨¡å¼ä¸‹çš„æŒ‰é’®æ—‹è½¬çŠ¶æ€ï¼šæ—‹è½¬-360åº¦å¹¶å›å¼¹ */
    body.dark-mode #theme-toggle {
        transform: rotate(-360deg);
    }

    /* å…¨å±å®¹å™¨ */
    .fullscreen-section {
        min-height: 100vh;
        width: 100%;
        display: flex;
        flex-direction: column;
        background: var(--bg-secondary);
        transition: background-color 0.3s;
    }
</style>

<!-- ç¬¬ä¸€éƒ¨åˆ†å¸ƒå±€ -->
<style>
    .main-container {
        display: flex;
        /* é»˜è®¤è¡Œå¸ƒå±€ (å®½ > é«˜) */
        flex-direction: row;
        width: 100%;
        flex: 1;
        /* å……æ»¡çˆ¶å®¹å™¨ */
        align-items: stretch;
        background: var(--bg-card);
        overflow: hidden;
        /* éšè—è¶…å‡ºå®¹å™¨çš„å†…å®¹ */
        transition: background-color 0.3s;
    }

    /* å“åº”å¼å¸ƒå±€ï¼šå½“æ˜¯ç«–å±ï¼ˆé«˜>=å®½ï¼‰æ—¶ï¼Œæ”¹ä¸ºä¸Šä¸‹å¸ƒå±€ */
    @media (orientation: portrait) {
        .main-container {
            flex-direction: column;
        }

        .info-panel {
            flex: 0 0 auto !important;
            /* ä¸ä¼¸ç¼©ï¼Œæ ¹æ®å†…å®¹å†³å®šé«˜åº¦ï¼Œä½†é™åˆ¶æœ€å¤§é«˜åº¦ */
            width: 100%;
            max-height: 55vh;
            /* é™åˆ¶é«˜åº¦ï¼ŒæŠŠç©ºé—´ç•™ç»™æ£‹ç›˜ */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05) !important;
            padding: 15px !important;
            /* å‡å°å†…è¾¹è· */
        }

        .board-panel {
            flex: 1;
            /* å æ®å‰©ä½™ç©ºé—´ */
            width: 100%;
            min-height: 40vh;
            /* ç¡®ä¿æ£‹ç›˜æœ‰ç©ºé—´ */
        }

    }

    /* å½“æ˜¯æ¨ªå±ï¼ˆå®½>é«˜ï¼‰ï¼Œä½†é«˜åº¦è¾ƒå°ï¼ˆç§»åŠ¨ç«¯/å¹³æ¿æ¨ªå±ï¼‰æ—¶ï¼Œå¼ºåˆ¶é”å®šé«˜åº¦ï¼Œå†…éƒ¨æ»šåŠ¨ */
    @media (orientation: landscape) and (max-height: 800px) {
        .fullscreen-section {
            height: 100vh !important;
            /* å¼ºåˆ¶é”å®šä¸ºä¸€å±é«˜åº¦ */
            min-height: 100vh !important;
        }

        .main-container {
            height: 100% !important;
            overflow: hidden !important;
            /* é˜²æ­¢å®¹å™¨è¢«å†…å®¹æ’‘å¼€ */
        }

        .info-panel {
            flex: 0 0 45% !important;
            /* æ¨ªå±æ—¶ç»™ä¿¡æ¯æ å¤šä¸€ç‚¹å®½åº¦ï¼Œé˜²æ­¢å¤ªæŒ¤ */
            height: 100% !important;
            overflow-y: auto !important;
            /* æ ¸å¿ƒï¼šè®©ä¿¡æ¯æ å†…éƒ¨æ»šåŠ¨ */
            padding: 15px !important;
        }

        .board-panel {
            flex: 1 !important;
            height: 100% !important;
            overflow: hidden !important;
        }

        /* è°ƒæ•´å†…éƒ¨å…ƒç´ è¾¹è·ï¼ŒèŠ‚çœç©ºé—´ */
        .header {
            margin-bottom: 10px !important;
        }

        .header h1 {
            margin-bottom: 2px !important;
            font-size: 20px !important;
        }

        .stats-grid {
            gap: 8px !important;
            margin-bottom: 10px !important;
        }

        .progress-section {
            margin-bottom: 15px !important;
        }
    }

    /* ä¿®æ”¹ç‚¹3ï¼šæ›´æ¿€è¿›çš„ç§»åŠ¨ç«¯/å°å±å¹•é€‚é… (768pxä»¥ä¸‹å°±è§¦å‘) */
    @media (max-width: 768px),
    (max-height: 800px) {

        /* æ ‡é¢˜ç¼©å° */
        .header h1 {
            font-size: 20px !important;
            margin-bottom: 5px !important;
        }

        .header p {
            font-size: 12px !important;
            margin-bottom: 10px !important;
        }

        .header {
            margin-bottom: 10px !important;
        }

        /* å¡ç‰‡ç¼©å° */
        .stats-grid {
            gap: 8px !important;
            margin-bottom: 15px !important;
        }

        .stat-card {
            padding: 10px !important;
            border-radius: 8px !important;
        }

        .stat-label {
            font-size: 10px !important;
            margin-bottom: 2px !important;
        }

        .stat-value {
            font-size: 18px !important;
        }

        /* è¿›åº¦æ¡åŒºåŸŸç¼©å° */
        .progress-section {
            margin-bottom: 15px !important;
        }

        .progress-header {
            font-size: 11px !important;
            margin-bottom: 5px !important;
        }

        .progress-container-inner {
            height: 16px !important;
            margin-top: 8px !important;
        }

        .mark {
            width: 16px !important;
            height: 16px !important;
            font-size: 8px !important;
        }

        /* æŒ‰é’®ç¼©å° */
        .btn-group {
            gap: 8px !important;
        }

        .btn {
            padding: 10px !important;
            font-size: 12px !important;
            border-radius: 6px !important;
        }

        /* é¢æ¿å†…è¾¹è·ç¼©å° */
        .info-panel {
            padding: 15px !important;
        }

        /* ä¸»é¢˜æŒ‰é’® */
        #theme-toggle {
            top: 10px !important;
            right: 10px !important;
            width: 30px !important;
            height: 30px !important;
            font-size: 14px !important;
        }
    }

    /* å·¦ä¾§ ä¿¡æ¯æ  */
    .info-panel {
        flex: 0 0 40%;
        width: 100%;
        background: var(--bg-card);
        box-shadow: 5px 0 15px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        padding: 30px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: center;
        /* å‚ç›´å±…ä¸­ */
        overflow-y: auto;
        /* å…è®¸å†…éƒ¨æ»šåŠ¨ */
        z-index: 10;
        min-width: 0;
        /* é˜²æ­¢ flex å­é¡¹æº¢å‡º */
        position: relative;
        /* ä¸ºç»å¯¹å®šä½çš„æŒ‰é’®æä¾›å‚è€ƒ */
        transition: background-color 0.3s;
    }

    /* å³ä¾§ æ£‹ç›˜åŒºåŸŸ */
    .board-panel {
        flex: 0 0 60%;
        width: 100%;
        background: var(--bg-secondary);
        box-sizing: border-box;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
        transition: background-color 0.3s;
    }

    /* æ£‹ç›˜ç¼©æ”¾å®¹å™¨ */
    .board-scaler {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        /* ç¡®ä¿ä¸ä¼šæº¢å‡º */
        overflow: hidden;
    }

    /* =========================================
       UI ç»„ä»¶ï¼šå·¦ä¾§ä¿¡æ¯
       ========================================= */

    /* æ ‡é¢˜ä¿¡æ¯ */
    .header {
        margin-bottom: 20px;
    }

    .header h1 {
        font-size: 28px;
        font-weight: 800;
        color: var(--primary);
        margin: 0 0 5px 0;
        letter-spacing: -1px;
    }

    .header p {
        color: var(--text-light);
        font-size: 14px;
        margin: 0;
    }

    /* ä¿¡æ¯å¡ç‰‡ */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: var(--bg-hover);
        border-radius: 12px;
        padding: 15px;
        text-align: left;
        border: 1px solid var(--border-color);
        transition: background-color 0.3s, border-color 0.3s;
    }

    .stat-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-light);
        font-weight: 600;
        display: block;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-main);
        display: block;
    }

    .stat-value.highlight {
        color: var(--success);
    }

    .stat-value.primary {
        color: var(--primary);
    }

    /* è¿›åº¦æ¡ */
    .progress-section {
        margin-bottom: 30px;
        position: relative;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 12px;
        color: var(--text-main);
    }

    .progress-container-inner {
        position: relative;
        height: 10px;
        background: var(--border-color);
        border-radius: 5px;
        margin-top: 10px;
        /* ç»™æ ‡è®°ç•™ç©ºé—´ */
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary) 0%, var(--info) 100%);
        border-radius: 5px;
        width: 0%;
        transition: width 0.3s ease;
    }

    .progress-marks {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
    }

    /* æ ‡è®°ç‚¹æ ·å¼ä¼˜åŒ– */
    .mark {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        /* åŠ å¤§ä¸€ç‚¹ä»¥å®¹çº³æ•°å­— */
        height: 20px;
        background: var(--bg-card);
        border: 2px solid var(--inactive-gray);
        /* é»˜è®¤æœªæ¿€æ´»ç°è‰² */
        color: var(--text-light);
        /* æœªæ¿€æ´»æ–‡å­—é¢œè‰² */
        border-radius: 50%;
        z-index: 2;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        /* æ•°å­—å¤§å° */
        font-weight: bold;

        /* ä¼˜åŒ–ç‚¹ï¼šå¹³æ»‘è¿‡æ¸¡ï¼Œä½¿ç”¨å¼¹æ€§è´å¡å°”æ›²çº¿ */
        transition: background-color 0.5s ease,
            border-color 0.5s ease,
            color 0.3s ease,
            transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* çŠ¶æ€1: å·²ç»æ¿€æ´» (Done) - ç»¿è‰² */
    .mark.passed {
        border-color: var(--success);
        background: var(--success);
        color: white;
        transform: translate(-50%, -50%) scale(1.0);
        /* æ­£å¸¸å¤§å° */
    }

    /* çŠ¶æ€2: æ­£åœ¨æ¿€æ´» (Current Active) - æ©™è‰²/è­¦å‘Šè‰² + å‘¼å¸æ•ˆæœ */
    .mark.active {
        border-color: var(--warning);
        background: var(--warning);
        color: white;
        box-shadow: 0 0 0 3px rgba(251, 99, 64, 0.3);
        transform: translate(-50%, -50%) scale(1.2);
        /* æ”¾å¤§ */
        z-index: 3;
    }

    /* æ“ä½œæŒ‰é’® */
    .btn-group {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 10px;
        margin-top: auto;
    }

    .btn {
        border: none;
        padding: 14px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11);
    }

    .btn-primary:active {
        animation: zoomEffect 0.2s ease-in-out infinite alternate;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
    }

    .btn-outline:hover {
        background: rgba(94, 114, 228, 0.1);
    }

    .btn-outline:active {
        background: rgba(94, 114, 228, 0.1);
        animation: zoomEffect 0.2s ease-in-out infinite alternate;
    }

    @keyframes zoomEffect {
        0% {
            transform: scale(1);
        }

        100% {
            transform: scale(0.90);
        }
    }

    /* =========================================
       UI ç»„ä»¶ï¼šå³ä¾§æ£‹ç›˜
       ========================================= */

    /* å³ä¾§æ£‹ç›˜ */
    table#chessboard {
        border-collapse: separate;
        border-spacing: 8px;
        /* å¢åŠ é—´è· */
        background: var(--bg-card);
        padding: 15px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        transition: transform 0.1s ease-out, background-color 0.3s;
        /* ç¼©æ”¾åŠ¨ç”» */
        transform-origin: center center;
        /* ä»ä¸­å¿ƒç¼©æ”¾ */
    }

    td {
        width: 60px;
        height: 60px;
        /* Fallback */
        aspect-ratio: 1 / 1;
        /* å¼ºåˆ¶æ­£æ–¹å½¢ */
        border: 1px solid var(--cell-border);
        border-radius: 10px;
        font-weight: bold;
        font-size: 18px;
        color: var(--cell-text);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background-color: var(--cell-bg);
        user-select: none;
        position: relative;
    }

    td:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        border-color: var(--primary);
    }

    /* é€‰ä¸­æ—¶çš„åŠ¨ç”» */
    .red-border {
        border: 2px solid #ff6b6b !important;
        animation: pulse 0.5s ease-in-out;
        z-index: 5;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.15);
        }

        100% {
            transform: scale(1);
        }
    }
</style>

<!-- ç¬¬äºŒéƒ¨åˆ†å¸ƒå±€ -->
<style>
    /* é€‰é¡¹å¡å¯¼èˆªåŒº */
    .tabs-section {
        background: var(--bg-card);
        padding: 20px;
        border-top: 1px solid var(--border-color);
        transition: background-color 0.3s, border-color 0.3s;
    }

    .tabs {
        display: flex;
        background-color: var(--bg-hover);
        border-radius: 10px;
        padding: 4px;
        margin: 0 auto 20px;
        max-width: 800px;
        transition: background-color 0.3s;
    }

    .tab-button {
        flex: 1;
        padding: 10px 0;
        text-align: center;
        font-size: 14px;
        cursor: pointer;
        border-radius: 8px;
        color: var(--text-light);
        transition: all 0.2s;
        font-weight: 500;
    }

    .tab-button.active {
        background-color: var(--bg-card);
        color: var(--primary);
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .tab-content-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* è®¾ç½®ç»„æ ·å¼ */
    .setting-group {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        transition: background-color 0.3s, border-color 0.3s;
    }

    .setting-group h4 {
        margin: 0 0 15px 0;
        font-size: 14px;
        color: var(--text-light);
        text-transform: uppercase;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
    }

    .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        font-size: 14px;
        color: var(--text-main);
    }

    .settings-item-input {
        width: 80px;
        padding: 6px 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        text-align: center;
        color: var(--text-main);
        background-color: var(--bg-input);
        font-weight: 600;
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
</style>

<!-- å…¶ä»–æ ·å¼ -->
<style>
    /* å›¾è¡¨å®¹å™¨ */
    .chart-container {
        width: 100%;
        height: auto;
        min-height: 250px;
        position: relative;
    }

    /* çƒŸèŠ±å®¹å™¨ */
    .firework {
        position: absolute;
        width: 100px;
        height: 100px;
        top: -40px;
        /* è°ƒæ•´ä½ç½®ä½¿å…¶å±…ä¸­ */
        left: -40px;
        pointer-events: none;
        z-index: 100;
    }

    .firework-particle {
        position: absolute;
        border-radius: 50%;
        opacity: 0;
    }

    /* å¼¹çª— */
    #customDialog {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
        z-index: 200;
        backdrop-filter: blur(4px);
    }

    .custom-dialog-content {
        background: var(--bg-card);
        padding: 30px;
        border-radius: 16px;
        width: 90%;
        max-width: 350px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        color: var(--text-main);
    }

    @keyframes popIn {
        from {
            transform: scale(0.8);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .h2_dialog {
        text-align: left;
        margin-top: 0;
        color: var(--text-main);
    }

    .dialog-btn {
        margin: 10px 5px;
        padding: 8px 20px;
        border-radius: 20px;
        border: none;
        cursor: pointer;
        font-weight: bold;
    }

    /* æ»‘å—æ ·å¼ä¼˜åŒ– */
    .slider-wrapper {
        position: relative;
        margin-top: 15px;
        color: var(--text-main);
        /* ç§»é™¤åº•éƒ¨ paddingï¼Œäº¤ç»™å†…éƒ¨å…ƒç´ æ§åˆ¶ */
    }

    /* æ–°å¢ï¼šæ»‘å—å¤´éƒ¨ï¼ˆæ ‡ç­¾+è¾“å…¥æ¡†ï¼‰ */
    .slider-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        font-size: 14px;
        color: var(--text-main);
    }

    /* æ–°å¢ï¼šRange å®¹å™¨ï¼Œç”¨äºåŒ…è£¹ range å’Œ tooltip */
    .range-container {
        position: relative;
        width: 100%;
        padding-bottom: 15px;
        /* ä¸ºä¸‹æ–¹çš„ Tooltip ç•™å‡ºç©ºé—´ */
    }

    input[type=range] {
        -webkit-appearance: none;
        /* ç§»é™¤é»˜è®¤æ ·å¼ */
        width: 100%;
        background: transparent;
        margin: 10px 0;
    }

    input[type=range]:focus {
        outline: none;
    }

    /* Webkit (Chrome, Safari, Edge) è½¨é“æ ·å¼ */
    input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 6px;
        cursor: pointer;
        background: var(--border-color);
        border-radius: 3px;
        transition: background-color 0.3s;
    }

    /* Webkit (Chrome, Safari, Edge) æ»‘å—åœ†é’®æ ·å¼ */
    input[type=range]::-webkit-slider-thumb {
        height: 18px;
        width: 18px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
        -webkit-appearance: none;
        margin-top: -6px;
        /* (è½¨é“é«˜åº¦ - æ»‘å—é«˜åº¦) / 2 = (6 - 18) / 2 = -6 */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: transform 0.1s, background-color 0.3s;
        border: 2px solid #fff;
        /* å¢åŠ ç™½è‰²æè¾¹æå‡å¯¹æ¯”åº¦ */
        z-index: 15;
        position: relative;
    }

    input[type=range]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
    }

    /* Tooltip æ ·å¼ä¼˜åŒ–ï¼šæ°”æ³¡å½¢çŠ¶ï¼ˆä¸‹æ–¹ï¼‰ */
    .slider-tooltip {
        position: absolute;
        background: var(--primary);
        color: #fff;
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: bold;

        /* æ”¾åˆ°æ»‘å—ä¸‹æ–¹ */
        top: 35px;
        left: 0;
        transform: translateX(-50%);

        display: none;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        z-index: 10;
        pointer-events: none;
        /* é˜²æ­¢é®æŒ¡é¼ æ ‡ */
        transition: background-color 0.3s;
    }

    /* æ°”æ³¡ä¸Šæ–¹çš„å°ä¸‰è§’ (æŒ‡ç¤ºå‘ä¸Š) */
    .slider-tooltip::before {
        content: "";
        position: absolute;
        top: -6px;
        /* ç§»åŠ¨åˆ°ç›’å­ä¸Šæ–¹ */
        left: 50%;
        transform: translateX(-50%);
        border-width: 0 6px 6px 6px;
        /* ä¸Šå³ä¸‹å·¦ï¼šä¸Š0ï¼Œä¸‹æœ‰é¢œè‰²ï¼Œå½¢æˆå‘ä¸Šçš„ä¸‰è§’ */
        border-style: solid;
        border-color: transparent transparent var(--primary) transparent;
    }

    /* ç»Ÿè®¡ç»“æœå°å­— */
    .result_p {
        font-size: 16px;
        color: var(--text-light);
        display: flex;
        justify-content: space-around;
        margin-top: 10px;
        background: var(--bg-hover);
        padding: 8px;
        border-radius: 6px;
        transition: background-color 0.3s;
    }

    #sponsorImg {
        width: 100%;
        max-width: 300px;
        display: none;
        margin: 10px auto;
    }
</style>

<script>

    // åˆå§‹åŒ–
    let loaded_first = true;    // æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡åŠ è½½
    let rows = 5;        // è¡Œæ•°
    let cols = 5;    // åˆ—æ•°
    let board = [];    // æ£‹ç›˜æ•°ç»„
    let weights = [];    // æƒé‡æ•°ç»„

    let drawnCount = 0; // æˆåŠŸæŠ½ä¸­æ¬¡æ•°
    let currentActions = 0; // å½“å‰è¡ŒåŠ¨æ¬¡æ•°

    let maxActions = 250;    // æœ€å¤§è¡ŒåŠ¨æ¬¡æ•°
    let firstWeight = 1;    // å…ˆæ‰‹æƒé‡
    let secondWeight = 4;    // åæ‰‹æƒé‡
    let settingsEnabled = true; // è®¾ç½®æ˜¯å¦å¯ç”¨

    let times = 10; // æ¨¡æ‹Ÿæ¬¡æ•°
    let draw_total_target = 28; // ç›®æ ‡æŠ½ç­¾æ•°é‡
    let winning_total_target = 19;  // ç›®æ ‡æŠ½ä¸­æ•°é‡
    let totalCells = 25;        // æ€»æ ¼å­æ•°

    // å…ƒç´ ç»„ä»¶
    const rows_element = document.getElementById('rows');
    const cols_element = document.getElementById('cols');
    const firstWeight_element = document.getElementById('first-weight');
    const secondWeight_element = document.getElementById('second-weight');
    const maxActions_element = document.getElementById('max-actions');
    const times_element = document.getElementById('times');
    const draw_total_element = document.getElementById('draw_total');
    const winning_total_element = document.getElementById('winning_total');
    const themeButton_element = document.getElementById('theme-toggle');

    // æ»‘å—å…ƒç´  & è¾“å…¥æ¡†å…ƒç´ 
    const lineChart_slider_element = document.getElementById('lineChart_slider');
    const lineChart_sliderTooltip_element = document.getElementById('lineChart_sliderTooltip');
    const lineChart_input_element = document.getElementById('lineChart_input'); // æ–°å¢

    const pieChart_slider_element = document.getElementById("pieChart_slider");
    const pieChart_sliderTooltip_element = document.getElementById("pieChart_sliderTooltip");

    const densityChart_slider_element = document.getElementById("densityChart_slider");
    const densityChart_sliderTooltip_element = document.getElementById("densityChart_sliderTooltip");

    // å›¾è¡¨å®ä¾‹
    let lineChart = null;
    let scatterChart = null;
    let pieChart = null;
    let densityChart = null;

    // å›¾è¡¨ä¸Šä¸‹æ–‡
    const ctx_lineChart = document.getElementById('lineChart').getContext('2d');
    const ctx_scatterChart = document.getElementById('scatterChart_tab3').getContext('2d');
    const ctx_pieChart = document.getElementById('pieChart_draw').getContext('2d');
    const ctx_densityChart = document.getElementById('scatterChart_winning').getContext('2d');

    // æ•°æ®å­˜å‚¨
    let data_single = [{ x: 0, y: 0 }];
    let data_multiple_brief = [{ x: 0, y: 0 }];
    let data_multiple_full = [{ x: 0, y: 0 }];
    let data3_endPoint = [];

    // åˆå§‹åŒ–
    document.addEventListener("DOMContentLoaded", () => {
        initTheme(); // åˆå§‹åŒ–ä¸»é¢˜
        initEvents();   // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        resetBoard();   // é‡ç½®æ£‹ç›˜
        drawChart_line(); // åˆå§‹ç»˜åˆ¶æŠ˜çº¿å›¾

        // åˆå§‹ç¼©æ”¾
        resizeBoard();

        // åˆå§‹åŒ–è¾“å…¥å€¼
        rows_element.value = rows;
        cols_element.value = cols;
        firstWeight_element.value = firstWeight;
        secondWeight_element.value = secondWeight;
        maxActions_element.value = maxActions;
        draw_total_element.value = draw_total_target;
        winning_total_element.value = winning_total_target;


        // ç§»åŠ¨ç«¯é€‚é…å¤„ç†æ–‡æ¡ˆ
        if (/Mobi|Android/i.test(navigator.userAgent)) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                const text = btn.textContent;
                if (text.includes('è®¾ç½®')) btn.textContent = 'âš™ï¸è®¾ç½®';
                if (text.includes('åˆ†æ')) btn.textContent = 'âœ’ï¸åˆ†æ';
                if (text.includes('ç»Ÿè®¡')) btn.textContent = 'ğŸ“ˆç»Ÿè®¡';
                if (text.includes('å…³äº')) btn.textContent = 'â„¹ï¸å…³äº';
            });
        }
    });

    // ç›‘å¬çª—å£å¤§å°æ”¹å˜ï¼Œè§¦å‘æ£‹ç›˜ç¼©æ”¾
    window.addEventListener('resize', resizeBoard);

    /* =========================================
       ä¸»é¢˜æ§åˆ¶
       ========================================= */
    function initTheme() {
        document.body.classList.remove('dark-mode');
        updateThemeUI();
        updateChartTheme();
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');

        updateThemeUI();
        updateChartTheme();

        // å¼ºåˆ¶é‡ç»˜å›¾è¡¨ä»¥åº”ç”¨æ–°é¢œè‰²
        if (lineChart) lineChart.update();
        if (scatterChart) scatterChart.update();
        if (pieChart) pieChart.update();
        if (densityChart) densityChart.update();
    }

    function updateThemeUI() {
        const isDark = document.body.classList.contains('dark-mode');
        const themeBtn = document.getElementById('theme-toggle');
        if (themeBtn) {
            themeBtn.textContent = isDark ? 'ğŸŒ™' : 'â˜€'; // åˆ‡æ¢å›¾æ ‡
        }
    }

    function updateChartTheme() {
        const isDark = document.body.classList.contains('dark-mode');
        const textColor = isDark ? '#a0aec0' : '#666';
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

        Chart.defaults.color = textColor;
        Chart.defaults.borderColor = gridColor;
        Chart.defaults.scale.grid.color = gridColor;
    }

    function initEvents() {
        // è¾“å…¥ç›‘å¬
        [rows_element, cols_element, firstWeight_element, secondWeight_element, maxActions_element].forEach(el => {
            el.addEventListener('input', () => {
                updateValue();
                updateLimit(); // é™åˆ¶æ›´æ–°éœ€è¦é‡æ–°è®¡ç®—
            });
        });

        // æ£‹ç›˜è§„æ ¼å˜åŒ–æ—¶ä¹Ÿè¦é‡æ–°ç¼©æ”¾
        rows_element.addEventListener('input', () => setTimeout(resizeBoard, 100));
        cols_element.addEventListener('input', () => setTimeout(resizeBoard, 100));

        times_element.addEventListener('input', updateValue);

        // ä¸ºæ‰€æœ‰ type="number" çš„è¾“å…¥æ¡†æ·»åŠ æ»šè½®æ”¯æŒ
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('wheel', function (e) {
                e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨

                // ç¡®å®šæ­¥é•¿ï¼Œé»˜è®¤ä¸º1ï¼Œå¦‚æœæœ‰stepå±æ€§åˆ™ä½¿ç”¨step
                const step = parseFloat(this.step) || 1;
                const min = parseFloat(this.min);
                const max = parseFloat(this.max);
                let val = parseFloat(this.value) || 0;

                if (e.deltaY < 0) {
                    val += step; // å‘ä¸Šæ»šåŠ¨å¢åŠ 
                } else {
                    val -= step; // å‘ä¸‹æ»šåŠ¨å‡å°‘
                }

                // æ£€æŸ¥èŒƒå›´
                if (!isNaN(min) && val < min) val = min;
                if (!isNaN(max) && val > max) val = max;

                this.value = val;

                // è§¦å‘ input äº‹ä»¶ä»¥æ›´æ–°ç›¸å…³é€»è¾‘
                this.dispatchEvent(new Event('input'));
            }, { passive: false });
        });

        // é€‰é¡¹å¡åˆ‡æ¢
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');

                if (tabId === 'tab-stats' && loaded_first) {
                    getdata_3_mul(times);
                    loaded_first = false;
                }
                if (tabId === 'tab-stats') {
                    // å¹³æ»‘æ»šåŠ¨
                    document.querySelector(".tabs-section").scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'      // æ»šåŠ¨åˆ°é€‰é¡¹å¡çš„é¡¶éƒ¨
                    });
                }
                else {
                    // å¹³æ»‘æ»šåŠ¨
                    document.querySelector(".tabs-section").scrollIntoView({
                        behavior: 'smooth',
                        block: 'end'      // æ»šåŠ¨åˆ°é€‰é¡¹å¡çš„åº•éƒ¨
                    });
                }
                toggle_sponsorImg(true);
            });
        });

        // =======================
        // æŠ˜çº¿å›¾æ»‘å—é€»è¾‘ (Smooth)
        // =======================
        lineChart_slider_element.addEventListener('input', function () {
            let val = Math.round(this.value);
            lineChart_input_element.value = Math.round(this.value);
            updateSliderTooltip(this, lineChart_sliderTooltip_element, this.value);
            drawChart_line_update(lineChart, data_single.slice(0, val + 1));
        });

        // æŠ˜çº¿å›¾è¾“å…¥æ¡†é€»è¾‘
        lineChart_input_element.addEventListener('input', function () {
            let val = parseInt(this.value);
            lineChart_slider_element.value = val;
            drawChart_line_update(lineChart, data_single.slice(0, val + 1));
        });

        // =======================
        // é¥¼å›¾æ»‘å—é€»è¾‘ (Smooth)
        // =======================
        pieChart_slider_element.addEventListener('input', function () {
            draw_total_target = Math.round(this.value);
            draw_total_element.value = draw_total_target;
            updateSliderTooltip(this, pieChart_sliderTooltip_element, this.value);
            drawChart_pie();
        });

        draw_total_element.addEventListener('input', function () {
            draw_total_target = parseInt(this.value);
            pieChart_slider_element.value = draw_total_target;
            drawChart_pie();
        });

        // =======================
        // å¯†åº¦å›¾æ»‘å—é€»è¾‘ (Smooth)
        // =======================
        densityChart_slider_element.addEventListener('input', function () {
            winning_total_target = Math.round(this.value);
            winning_total_element.value = winning_total_target;
            updateSliderTooltip(this, densityChart_sliderTooltip_element, this.value);
            drawChart_density();
        });

        winning_total_element.addEventListener('input', function () {
            winning_total_target = parseInt(this.value);
            densityChart_slider_element.value = winning_total_target;
            drawChart_density();
        });
    }

    /* =========================================
       æ¸¸æˆæ ¸å¿ƒé€»è¾‘
       ========================================= */

    const table = document.getElementById("chessboard");

    function createBoard() {
        table.innerHTML = "";
        for (let i = 0; i < rows; i++) {
            const row = document.createElement("tr");
            board[i] = [];
            for (let j = 0; j < cols; j++) {
                const cell = document.createElement("td");
                cell.id = `cell-${i}-${j}`;
                cell.dataset.value = "0";
                row.appendChild(cell);
                board[i][j] = 0;
            }
            table.appendChild(row);
        }
        // é‡å»ºåç«‹å³è®¡ç®—ç¼©æ”¾
        setTimeout(resizeBoard, 0);
    }

    // æ£‹ç›˜ç¼©æ”¾æ ¸å¿ƒé€»è¾‘
    function resizeBoard() {
        const table = document.getElementById('chessboard');
        const container = document.querySelector('.board-panel');

        if (!container || !table) return; // ç¡®ä¿å…ƒç´ å­˜åœ¨

        // 1. å…ˆé‡ç½® transformï¼Œè·å–åŸå§‹å°ºå¯¸
        table.style.transform = 'none';

        let naturalWidth = table.offsetWidth;
        let naturalHeight = table.offsetHeight;
        let naturalSize = Math.min(naturalWidth, naturalHeight);

        // 2. è·å–å®¹å™¨å°ºå¯¸ï¼ˆä¸å†ä½¿ç”¨ viewport å°ºå¯¸ï¼‰
        const cw = container.clientWidth;
        const ch = container.clientHeight;

        // 3. è®¡ç®—ç›®æ ‡å°ºå¯¸
        // éœ€æ±‚ï¼š"åŸºäºè·ç¦»å®¹å™¨çš„æœ€çŸ­é•¿æˆ–å®½" -> ç›®æ ‡æ˜¯ 80% çš„æœ€çŸ­è¾¹
        const shortestSide = Math.min(cw, ch);
        const targetSize = shortestSide * 0.8;

        // 4. è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
        const scale = targetSize / naturalSize;

        // 5. åº”ç”¨ç¼©æ”¾
        table.style.transform = `scale(${scale})`;

    }

    function performAction() {
        if (drawnCount >= totalCells) return;

        const [row, col] = selectCell(board);
        const cellElement = document.getElementById(`cell-${row}-${col}`);
        board[row][col]++;
        currentActions++;
        cellElement.textContent = board[row][col];

        if (board[row][col] === 1) {
            drawnCount++;
        }

        // é¢œè‰²é€»è¾‘
        if (board[row][col] <= 5) {
            let alpha = Math.min(0.2 + board[row][col] * 0.1, 1);
            cellElement.style.backgroundColor = `rgba(255, 235, 59, ${alpha})`; // é»„
            cellElement.style.color = '#333'; // ç¡®ä¿æµ…è‰²èƒŒæ™¯ä¸‹æ–‡å­—å¯è§
        } else if (board[row][col] <= 10) {
            let alpha = Math.min(0.2 + (board[row][col] - 5) * 0.1, 1);
            cellElement.style.backgroundColor = `rgba(255, 165, 0, ${alpha})`; // æ©™
            cellElement.style.color = '#333';
        } else {
            let alpha = Math.min(0.2 + (board[row][col] - 10) * 0.1, 1);
            cellElement.style.backgroundColor = `rgba(255, 87, 34, ${alpha})`; // çº¢
            cellElement.style.color = '#fff'; // æ·±è‰²èƒŒæ™¯ä¸‹æ–‡å­—å˜ç™½
        }

        // åŠ¨ç”»
        cellElement.classList.remove("red-border");
        void cellElement.offsetWidth; // Trigger reflow
        cellElement.classList.add("red-border");

        updateStats();
        disableSettings();
        data2_push(currentActions, drawnCount);

        // æ›´æ–°æŠ˜çº¿å›¾èŒƒå›´
        lineChart_slider_element.max = currentActions;
        lineChart_slider_element.value = currentActions;
        lineChart_input_element.max = currentActions;
        lineChart_input_element.value = currentActions;

        drawChart_line();

        checkGameEnd();
    }

    function selectCell(array) {
        weights = [];
        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                weights.push(array[i][j] === 0 ? firstWeight : secondWeight);
            }
        }

        let totalWeight = weights.reduce((acc, cur) => acc + cur, 0);
        let random = Math.random() * totalWeight;

        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                random -= weights[i * cols + j];
                if (random <= 0) {
                    return [i, j];
                }
            }
        }
        return [0, 0]; // fallback
    }

    function resetBoard() {
        board = [];
        drawnCount = 0;
        currentActions = 0;
        updateValue(); // ç¡®ä¿ä½¿ç”¨å½“å‰è®¾ç½®
        init_data2();
        createBoard();
        markGenerate(1, totalCells, 6);
        updateStats();
        enableSettings();

        // é‡ç½®æŠ˜çº¿å›¾æ»‘å—
        lineChart_slider_element.max = 0.1; // é‡ç½®ä¸ºå°å€¼
        lineChart_slider_element.value = 0;
        lineChart_input_element.max = 0;
        lineChart_input_element.value = 0;

        drawChart_line();
    }

    function checkGameEnd() {
        if (drawnCount === totalCells) {
            showCustomDialog("æ­å–œï¼š", ["æ‰€æœ‰æ–¹æ ¼å·²ç¿»è½¬ï¼"]);
        } else if (currentActions >= maxActions) {
            // å¼ºåˆ¶ç¿»å¼€
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    if (board[i][j] === 0) {
                        board[i][j] = 1;
                        const el = document.getElementById(`cell-${i}-${j}`);
                        el.textContent = "-";
                        el.style.backgroundColor = "rgba(45, 206, 137, 0.3)";
                        el.style.color = "var(--text-main)";
                    }
                }
            }
            drawnCount = totalCells;
            updateStats();
            showCustomDialog("æç¤ºï¼š", ["è¡ŒåŠ¨æ¬¡æ•°å·²è¾¾åˆ°ä¸Šé™", "å·²å¼ºåˆ¶ç¿»è½¬å‰©ä½™æ ¼å­"]);
        }
    }

    function updateStats() {
        document.getElementById("drawn-count").textContent = drawnCount;
        document.getElementById("current-actions").textContent = currentActions;
        document.getElementById("progress-value").textContent = parseInt(drawnCount / totalCells * 100) + "%";
        updateProgress();
    }

    function updateValue() {
        rows = parseInt(rows_element.value);
        cols = parseInt(cols_element.value);
        totalCells = rows * cols;
        firstWeight = parseInt(firstWeight_element.value);
        secondWeight = parseInt(secondWeight_element.value);
        maxActions = parseInt(maxActions_element.value);
        times = parseInt(times_element.value);
    }

    function updateLimit() {
        // æ›´æ–°ç»Ÿè®¡å›¾è¡¨çš„æ»‘å—ä¸Šé™
        loaded_first = true;
        draw_total_element.max = maxActions;
        pieChart_slider_element.max = maxActions;

        winning_total_element.max = totalCells;
        densityChart_slider_element.max = totalCells;

        // å¼ºåˆ¶é‡ç»˜
        if (!settingsEnabled) return; // å¦‚æœæ­£åœ¨æ¸¸æˆä¸­ï¼Œä¸å¼ºåˆ¶åˆ·æ–°å›¾è¡¨ä»¥å…å½±å“
    }

    function toggleSettings(object, flag) {
        object.disabled = flag;
        object.style.opacity = flag ? 0.5 : 1;
    }
    function enableSettings() {
        [rows_element, cols_element, firstWeight_element, secondWeight_element, maxActions_element].forEach(el => toggleSettings(el, false));
        settingsEnabled = true;
    }
    function disableSettings() {
        if (settingsEnabled) {
            [rows_element, cols_element, firstWeight_element, secondWeight_element, maxActions_element].forEach(el => toggleSettings(el, true));
            settingsEnabled = false;
        }
    }

    /* =========================================
   è¿›åº¦æ¡ä¸çƒŸèŠ±
   ========================================= */
    let marks_elements = [];

    function markGenerate(min, max, num) {
        const container = document.querySelector('.progress-marks');
        container.innerHTML = '';

        const step = (max - min) / (num - 1);
        const marks = [];
        for (let i = 0; i < num; i++) marks.push(Math.round(min + i * step));
        if (!marks.includes(max)) marks[marks.length - 1] = max;

        const uniqueMarks = [...new Set(marks)].sort((a, b) => a - b);

        marks_elements = uniqueMarks.map(val => {
            const mark = document.createElement('div');
            mark.className = 'mark';
            mark.dataset.value = val;
            mark.textContent = val; // æ–°å¢ï¼šåœ†ç‚¹å†…éƒ¨æ˜¾ç¤ºæ•°å­—

            const fw = document.createElement('div');
            fw.className = 'firework';
            mark.appendChild(fw);

            // ä½ç½®è®¡ç®— (0% - 100%)
            const leftPct = (val / max) * 100;
            mark.style.left = `${leftPct}%`;

            container.appendChild(mark);
            return mark;
        });
    }

    function updateProgress() {
        const pct = (drawnCount / totalCells) * 100;
        document.getElementById('progress-fill').style.width = `${pct}%`;

        let currentActiveVal = -1;

        // æ‰¾åˆ°å°äºç­‰äºå½“å‰è¿›åº¦çš„æœ€å¤§æ ‡è®°å€¼
        marks_elements.forEach(mark => {
            const val = parseInt(mark.dataset.value);
            if (drawnCount >= val) {
                if (val > currentActiveVal) currentActiveVal = val;
            }
        });

        marks_elements.forEach(mark => {
            const val = parseInt(mark.dataset.value);

            if (val === currentActiveVal) {
                // è¿™æ˜¯å½“å‰"æ­£åœ¨æ¿€æ´»/æœ€æ–°è¾¾æˆ"çš„ç‚¹ -> æ ·å¼ï¼šactive (æ©™è‰²+çƒŸèŠ±)
                mark.classList.remove('passed'); // ç§»é™¤ passed çŠ¶æ€
                mark.classList.add('active'); // æ·»åŠ  active çŠ¶æ€

                // åªæœ‰å½“å®ƒä¹‹å‰ä¸æ˜¯activeæ—¶æ‰è§¦å‘çƒŸèŠ±ï¼ˆé˜²æ­¢æ¯æ¬¡updateéƒ½è§¦å‘ï¼‰
                // ä½†ç”±äºresetä¼šæ¸…ç©ºï¼Œè¿™é‡Œç®€å•åˆ¤æ–­å³å¯ã€‚
                // ä¸ºäº†ä¿è¯çƒŸèŠ±åŠ¨ç”»èƒ½é‡æ’­ï¼Œå¯ä»¥æ£€æµ‹å…ƒç´ çŠ¶æ€
                // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šæ¯æ¬¡è¿›å…¥ActiveçŠ¶æ€éƒ½å°è¯•è§¦å‘
                const fw = mark.querySelector('.firework');
                if (fw.innerHTML === '') {
                    createFireworks(fw);
                }
            } else if (val < currentActiveVal) {
                // è¿™æ˜¯ä»¥å‰è¾¾æˆè¿‡çš„ç‚¹ -> æ ·å¼ï¼špassed (ç»¿è‰²ï¼Œæ— çƒŸèŠ±)
                mark.classList.remove('active'); // ç§»é™¤ active çŠ¶æ€
                mark.classList.add('passed'); // æ·»åŠ  passed çŠ¶æ€
                mark.querySelector('.firework').innerHTML = ''; // æ¸…é™¤çƒŸèŠ±
            } else {
                // æœªæ¥çš„ç‚¹ -> é»˜è®¤æ ·å¼ (ç°è‰²)
                mark.classList.remove('active', 'passed');
                mark.querySelector('.firework').innerHTML = '';
            }
        });
    }

    // çƒŸèŠ±
    function createFireworks(container) {
        container.innerHTML = '';
        const colors = ['#f56565', '#4299e1', '#48bb78', '#ed8936', '#9f7aea'];
        for (let i = 0; i < 16; i++) {
            const p = document.createElement('div');
            p.className = 'firework-particle';
            const size = 3 + Math.random() * 5;
            p.style.width = size + 'px'; p.style.height = size + 'px';
            p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            p.style.left = '50%'; p.style.top = '50%';

            const angle = Math.random() * Math.PI * 2;
            const dist = 30 + Math.random() * 40;

            const anim = p.animate([
                { transform: 'translate(-50%, -50%) scale(0)', opacity: 1 },
                { transform: `translate(calc(-50% + ${Math.cos(angle) * dist}px), calc(-50% + ${Math.sin(angle) * dist}px)) scale(1.5)`, opacity: 0 }
            ], { duration: 800 + Math.random() * 400, easing: 'cubic-bezier(0, .9, .57, 1)' });

            container.appendChild(p);
        }
    }

    /* =========================================
       æ•°æ®ç®¡ç†
       ========================================= */
    function init_data2() { data_single = [{ x: 0, y: 0 }]; }
    function data2_push(x, y) { data_single.push({ x, y }); }
    function init_data3() {
        data_multiple_brief = [{ x: 0, y: 0 }];
        data_multiple_full = [{ x: 0, y: 0 }];
        data3_endPoint = [];
    }

    // å¸¦ç‰¹æ•ˆçš„è¿è¡Œç»Ÿè®¡å‡½æ•°
    function runStatsWithEffect() {
        const btn = document.getElementById('btn-run-stats');
        const originalText = btn.innerText;


        // 1. è®¾ç½®ç­‰å¾…çŠ¶æ€ (å¯åŠ¨æµå…‰åŠ¨ç”»)
        btn.classList.add('btn-loading');
        btn.innerText = "è®¡ç®—ä¸­..."; // æç¤ºç”¨æˆ·æ­£åœ¨è®¡ç®—
        btn.disabled = true;

        const N = parseInt(document.getElementById('times').value);
        getdata_3_mul(N);
        btn.classList.remove('btn-loading');
        btn.innerText = originalText;
        btn.disabled = false;
    }

    // ç»Ÿè®¡å‡½æ•°
    function getdata_3_mul(N) {
        init_data3();

        for (let round = 0; round < N; round++) {

            let tempBoard = Array.from({ length: rows }, () => new Array(cols).fill(0));
            let uniqueFound = 0, currentStep = 0;
            let ended = false;

            while (!ended) {

                let totalW = 0;
                // ç¬¬ä¸€æ¬¡éå†ï¼šè®¡ç®—æ€»æƒé‡
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        totalW += (tempBoard[r][c] === 0 ? firstWeight : secondWeight);
                    }
                }

                let rand = Math.random() * totalW;
                let r = 0, c = 0;

                // ç¬¬äºŒæ¬¡éå†ï¼šæ ¹æ®éšæœºæ•°ç¡®å®šä½ç½®
                // ä½¿ç”¨ label è·³å‡ºåŒå±‚å¾ªç¯
                searchLoop:
                for (r = 0; r < rows; r++) {
                    for (c = 0; c < cols; c++) {
                        let weight = (tempBoard[r][c] === 0 ? firstWeight : secondWeight);
                        rand -= weight;
                        if (rand <= 0) {
                            break searchLoop;
                        }
                    }
                }
                // è¾¹ç•Œä¿æŠ¤ï¼šå¦‚æœæµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜å¯¼è‡´æ²¡é€‰åˆ°ï¼Œé»˜è®¤é€‰æœ€åä¸€ä¸ªï¼ˆè™½æç½•è§ï¼‰
                if (r === rows) { r = rows - 1; c = cols - 1; }

                tempBoard[r][c]++;
                currentStep++;
                if (tempBoard[r][c] === 1) uniqueFound++;

                data_multiple_full.push({ x: currentStep, y: uniqueFound });

                if (tempBoard[r][c] === 1) data_multiple_brief.push({ x: currentStep, y: uniqueFound });

                // ç»“æŸæ¡ä»¶
                if (uniqueFound === totalCells) {
                    data3_endPoint.push(currentStep);
                    ended = true;
                } else if (currentStep >= maxActions) {
                    data_multiple_brief.push({ x: currentStep, y: totalCells });
                    data_multiple_full.push({ x: currentStep, y: totalCells });
                    ended = true;
                }
            }
        }

        // ç»˜åˆ¶æ‰€æœ‰é«˜çº§å›¾è¡¨
        drawChart_scatter();
        drawChart_pie();
        drawChart_density();
    }

    // æ•°æ®å¤„ç†è¾…åŠ©å‡½æ•°
    function getBubbleChartData(data) {
        const countMap = {};
        data.forEach(item => {
            const key = `${item.x},${item.y}`;
            countMap[key] = (countMap[key] || 0) + 1;
        });
        return Object.keys(countMap).map(key => {
            const [x, y] = key.split(',');
            return { x: parseFloat(x), y: parseFloat(y), r: countMap[key] };
        });
    }

    function getScatterChartData(data, p = false) {
        const countMap = {};
        data.forEach(item => { countMap[item] = (countMap[item] || 0) + 1; });
        const totalCount = data.length;
        return Object.keys(countMap).map(key => {
            let x = parseInt(key);
            let y = p ? (countMap[key] / totalCount * 100) : countMap[key];
            return { x, y };
        });
    }

    function getPieChartData(data) {
        const countMap = getScatterChartData(data);
        const probabilities = countMap.map(item => ({
            y: item.x,
            count: item.y,
            probability: (item.y / data.length) * 100
        })).sort((a, b) => b.probability - a.probability);

        const yValues = probabilities.map(item => item.count);
        const labels = probabilities.map(item => `index: ${item.y}`);
        const colors = probabilities.map(() => getRandomColor([0, 360], [30, 70], [70, 90]));

        return {
            labels: labels,
            datasets: [{
                label: 'Value Distribution',
                data: yValues,
                backgroundColor: colors,
                borderColor: ['#fff'],
                borderWidth: 1,
                extra: probabilities
            }]
        };
    }

    function accumulatedProbability(data) {
        const sortedData = [...data].sort((a, b) => a.x - b.x);
        let cumulative = 0;
        return sortedData.map(item => {
            cumulative += item.y;
            return { x: item.x, y: item.y, r: cumulative };
        });
    }

    function filterData(data, targetValue, keyChecked, keySelected) {
        return data.filter(item => item[keyChecked] == targetValue).map(item => item[keySelected]);
    }

    function supplementData_draw(data, targetValue) {
        data3_endPoint.forEach(value => { if (targetValue > value) data.push(totalCells); });
    }

    function supplementData_winning(data, targetValue) {
        let supplementCount = targetValue - data.length;
        for (let i = 0; i < supplementCount; i++) data.push(maxActions);
    }

    function calculateStatistics(data) {
        if (data.length === 0) return { min: null, median: null, max: null };
        data.sort((a, b) => a - b);
        const medianValue = data.length % 2 === 0
            ? (data[data.length / 2 - 1] + data[data.length / 2]) / 2
            : data[Math.floor(data.length / 2)];
        return { min: data[0], median: medianValue, max: data[data.length - 1] };
    }

    function getRandomColor(hRange = [0, 360], sRange = [0, 100], lRange = [0, 100]) {
        const h = Math.floor(Math.random() * (hRange[1] - hRange[0])) + hRange[0];
        const s = Math.floor(Math.random() * (sRange[1] - sRange[0])) + sRange[0];
        const l = Math.floor(Math.random() * (lRange[1] - lRange[0])) + lRange[0];
        return `hsl(${h}, ${s}%, ${l}%)`;
    }

    /* =========================================
   å›¾è¡¨ç»˜åˆ¶
   ========================================= */

    // é”€æ¯å›¾ä¾‹
    function destroyChart(chartInstance) {
        if (chartInstance) chartInstance.destroy();
    }

    // æŠ˜çº¿å›¾ç»˜åˆ¶
    function drawChart_line() {
        if (!lineChart) {
            lineChart = drawChart_line_init("", ctx_lineChart, lineChart, data_single);
        } else {
            drawChart_line_update(lineChart, data_single);
        }
    }
    function drawChart_line_update(chartInstance, data) {
        chartInstance.data.labels = data.map(item => `(${item.x}, ${item.y})`);
        chartInstance.data.datasets[0].data = data;
        chartInstance.update();
    }
    function drawChart_line_init(titleName, ctx, chartInstance, data) {
        destroyChart(chartInstance);
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(item => `(${item.x}, ${item.y})`),
                datasets: [{
                    data: data,
                    backgroundColor: 'rgba(0, 120, 212,0.1)',
                    borderColor: 'rgba(0, 120, 212,0.6)',
                    borderWidth: 1,
                    radius: 3,
                    fill: true,
                    tension: 0.3,
                }]
            },
            options: {
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: (ctx) => `Index: ${ctx[0].label}`,
                            label: (item) => 'Total: ' + item.raw.y.toFixed(0)
                        }
                    },
                    title: { display: !!titleName, text: titleName, position: 'bottom', font: { size: 14 } }
                },
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'linear', position: 'bottom', ticks: { stepSize: 1, beginAtZero: true } },
                    y: { ticks: { stepSize: 1, beginAtZero: true, callback: (v) => v.toFixed(0) } }
                }
            }
        });
    }

    // æ•£ç‚¹å›¾ç»˜åˆ¶
    function drawChart_scatter() {
        let data = getBubbleChartData(data_multiple_brief);
        scatterChart = drawChart_scatter_init("", ctx_scatterChart, scatterChart, data);
    }
    function drawChart_scatter_init(titleName, ctx, chartInstance, data) {
        destroyChart(chartInstance);
        return new Chart(ctx, {
            type: 'scatter',
            data: {
                labels: data.map(item => `(${item.x}, ${item.y})`),
                datasets: [{
                    data: data,
                    backgroundColor: 'rgba(0, 120, 212,0.4)',
                    borderColor: 'rgba(0, 120, 212,0.6)',
                    borderWidth: 1,
                    radius: 3,
                }]
            },
            options: {
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: (ctx) => ctx[0].label,
                            label: (item) => 'Count: ' + item.raw.r.toFixed(0)
                        }
                    },
                    title: { display: !!titleName, text: titleName, position: 'bottom', font: { size: 14 } }
                },
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'linear', position: 'bottom', ticks: { stepSize: 1, beginAtZero: true } },
                    y: { ticks: { stepSize: 1, beginAtZero: true, callback: (v) => v.toFixed(0) } }
                }
            }
        });
    }
    // é¥¼å›¾ç»˜åˆ¶
    let pieChart_data;
    function drawChart_pie_getData() {
        pieChart_data = filterData(data_multiple_full, draw_total_target, 'x', 'y');
        supplementData_draw(pieChart_data, draw_total_target);
    }
    function drawChart_pie() {
        drawChart_pie_getData();
        drawChart_pie_textUpdate();
        let data = getPieChartData(pieChart_data);
        if (!pieChart) {
            pieChart = drawChart_pie_init("", ctx_pieChart, pieChart, data);
        } else {
            drawChart_pie_update(pieChart, data);
        }
    }
    function drawChart_pie_update(chartInstance, data) {
        chartInstance.data = data;
        chartInstance.update();
    }
    function drawChart_pie_textUpdate() {
        let data = calculateStatistics(pieChart_data);
        document.getElementById('d_min').textContent = `ğŸ”·æœ€å°å€¼: ${data.min}`;
        document.getElementById('d_median').textContent = `âš–ï¸ä¸­ä½æ•°: ${data.median}`;
        document.getElementById('d_max').textContent = `ğŸ”¶æœ€å¤§å€¼: ${data.max}`;
    }
    function drawChart_pie_init(titleName, ctx, chartInstance, data, topN = 15) {
        destroyChart(chartInstance);
        return new Chart(ctx, {
            type: 'pie',
            data: data,
            options: {
                plugins: {
                    legend: {
                        display: true, position: 'right',
                        labels: { filter: (item, data) => data.labels.indexOf(item.text) < topN }
                    },
                    tooltip: {
                        callbacks: {
                            label: (item) => {
                                let d = item.dataset.extra[item.dataIndex];
                                let prob = d.probability % 1 === 0 ? d.probability.toFixed(1) : parseFloat(d.probability.toFixed(4));
                                return `Probability: ${prob}%`;
                            }
                        }
                    },
                    title: { display: !!titleName, text: titleName, position: 'bottom', font: { size: 14 } }
                },
                responsive: true, maintainAspectRatio: false
            }
        });
    }

    // å¯†åº¦å›¾ç»˜åˆ¶
    let densityChart_data;
    function drawChart_density_getData() {
        densityChart_data = filterData(data_multiple_brief, winning_total_target, 'y', 'x');
        supplementData_winning(densityChart_data, times);
    }
    function drawChart_density() {
        drawChart_density_getData();
        drawChart_density_textUpdate();
        let sData = getScatterChartData(densityChart_data, true);
        let data = accumulatedProbability(sData);
        if (!densityChart) {
            densityChart = drawChart_density_init("", ctx_densityChart, densityChart, data);
        } else {
            drawChart_density_update(densityChart, data);
        }
    }
    function drawChart_density_update(chartInstance, data) {
        chartInstance.data.datasets[0].data = data;
        chartInstance.data.labels = data.map(item => `(${item.x}, ${item.y})`);
        chartInstance.update();
    }
    function drawChart_density_textUpdate() {
        let data = calculateStatistics(densityChart_data);
        document.getElementById('w_min').textContent = `ğŸ”·æœ€å°å€¼: ${data.min}`;
        document.getElementById('w_median').textContent = `âš–ï¸ä¸­ä½æ•°: ${data.median}`;
        document.getElementById('w_max').textContent = `ğŸ”¶æœ€å¤§å€¼: ${data.max}`;
    }
    function drawChart_density_init(titleName, ctx, chartInstance, data) {
        destroyChart(chartInstance);
        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(item => `(${item.x}, ${item.y})`),
                datasets: [{
                    data: data,
                    backgroundColor: 'rgba(0, 120, 212,0.4)',
                    borderColor: 'rgba(0, 120, 212,0.6)',
                    borderWidth: 1,
                }]
            },
            options: {
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        displayColors: false, // éšè—å›¾ä¾‹é¢œè‰²å—
                        callbacks: {
                            title: (ctx) => `Index: ${ctx[0].label}`,
                            label: (item) => [`ğŸŒŸP: ${item.raw.y.toFixed(2)}%`, `ğŸ¡ACC: ${item.raw.r.toFixed(2)}%`]
                        }
                    },
                    title: { display: !!titleName, text: titleName, position: 'bottom', font: { size: 14 } }
                },
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'linear', position: 'bottom', ticks: { stepSize: 1, beginAtZero: true } },
                    y: { ticks: { beginAtZero: true, callback: (v) => v.toFixed(0) + '%' } }
                }
            }
        });
    }

    // æ»‘å— Tooltip ä¼˜åŒ–ï¼šä½ç½®å›ºå®šåœ¨ä¸‹æ–¹ + é˜²æŠ–åŠ¨é€»è¾‘
    const tooltipTimeouts = {}; // ç”¨äºå­˜å‚¨æ¯ä¸ªæ»‘å—çš„å®šæ—¶å™¨ID

    function updateSliderTooltip(slider, tooltip, val) {
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼Œé˜²æ­¢åœ¨æ‹–åŠ¨è¿‡ç¨‹ä¸­éšè—
        if (tooltipTimeouts[slider.id]) {
            clearTimeout(tooltipTimeouts[slider.id]);
        }

        tooltip.style.display = 'block';
        tooltip.textContent = Math.round(val);
        const pct = (val - slider.min) / (slider.max - slider.min);

        // è®¡ç®— left ä½ç½® (è®©å…¶è·Ÿéšæ»‘å—ç§»åŠ¨)
        tooltip.style.left = `calc(${pct * 100}% + ${(0.5 - pct) * 18}px)`; // 18px æ˜¯ thumb å®½åº¦

        // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œåœæ­¢æ“ä½œ2ç§’åéšè—
        tooltipTimeouts[slider.id] = setTimeout(() => {
            tooltip.style.display = 'none';
        }, 2000);
    }

    /* =========================================
        æ‚é¡¹
        ========================================= */

    function showCustomDialog(title, texts) {
        document.getElementById('headSpan').textContent = title;
        const container = document.getElementById('info_container');
        container.innerHTML = '';
        texts.forEach(t => {
            const p = document.createElement('p');
            p.textContent = t;
            container.appendChild(p);
        });
        document.getElementById('customDialog').style.display = 'flex';
    }

    document.getElementById('confirmButton').onclick = () => document.getElementById('customDialog').style.display = 'none';
    document.getElementById('retryButton').onclick = () => {
        document.getElementById('customDialog').style.display = 'none';
        resetBoard();
    };

    function toggle_sponsorImg(flag) {

        const img = document.getElementById('sponsorImg');
        // å¦‚æœæœªä¼ å…¥å‚æ•° flagï¼Œåˆ™æ ¹æ®å½“å‰æ˜¾ç¤ºçŠ¶æ€è®¡ç®—é»˜è®¤å€¼
        if (flag === undefined) {
            flag = img.style.display === 'block';
        }
        // æ ¹æ® flag çš„å€¼åˆ‡æ¢å›¾ç‰‡æ˜¾ç¤ºçŠ¶æ€
        img.style.display = flag ? 'none' : 'block';
    }
</script>

</html>